# PyMilvus Dify 插件

一个全面的、生产就绪的 Milvus 向量数据库插件，为 Dify 平台提供企业级向量数据库操作和高级 RAG（检索增强生成）能力。

## 🚀 核心特性

### 🎯 **高级 RAG 能力**
- **语义文本搜索**: 与 Dify 内置嵌入模型无缝集成的智能文本向量搜索
- **多路径召回**: 向量 + 关键词 + 语义匹配，实现最大覆盖率
- **智能分块**: 采用重叠策略的优化文档分段
- **查询扩展**: 同义词扩展和意图重写，获得更佳结果

### 🗂️ **完整的集合管理**
- **创建集合**: 支持 BM25 和向量的高级模式设计
- **列表与描述**: 全面的集合元数据和统计信息
- **删除集合**: 带确认机制的安全删除
- **索引优化**: HNSW 索引，卓越性能表现

### 📊 **高级数据操作**
- **批量插入**: 带验证的高效批量数据加载
- **智能查询**: 动态字段选择的复杂过滤
- **条件删除**: 带安全检查的精确数据移除
- **实时统计**: 实时集合指标和健康监控

### 🔍 **智能搜索系统**
- **向量相似性**: COSINE、L2、IP 指标，参数可配置
- **BM25 全文**: 排名优化的传统关键词搜索
- **混合搜索**: 向量和关键词搜索结合，获得最佳结果
- **结果过滤**: 高级相似度阈值和字段选择

### 🧠 **Dify 集成**
- **内置模型**: 与 Dify 嵌入生态系统无缝集成
- **系统级配置**: 无需管理单独的 API 密钥
- **自动扩展**: 基于工作空间配置的动态模型选择
- **错误恢复**: 全面的回退和重试机制

## 📋 前置条件

- **Milvus**: 2.3.0+ 服务器实例
- **Dify 平台**: 1.6.0+（最新模型集成所需）
- **Python 运行时**: 3.8+ 环境
- **网络**: 到 Milvus 服务器的稳定连接

## ⚙️ 配置

### Milvus 数据库连接
| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| `uri` | 字符串 | ✅ | Milvus 服务器 URI（例如：`https://your-milvus.com`）|
| `user` | 字符串 | ✅ | 数据库用户名 |
| `password` | 字符串 | ✅ | 数据库密码 |
| `db_name` | 字符串 | ❌ | 目标数据库（默认：`default`）|

### 模型配置
**🎉 v0.0.1 新特性**：插件现在使用 Dify 系统级模型配置。无需配置单独的嵌入提供商！

- 文本嵌入模型自动从您的 Dify 工作空间选择
- 模型选择在应用程序/工作流级别管理
- 支持在您的 Dify 实例中配置的所有嵌入模型

## 🛠️ 可用工具

### 集合管理

#### **创建集合**
创建支持高级模式的向量集合：
```yaml
参数:
  collection_name: 唯一集合标识符
  dimension: 向量维度（1-32768）
  metric_type: 距离度量（COSINE/L2/IP）
  description: 集合描述
  enable_bm25: 启用全文搜索功能
```

#### **列出集合**
枚举所有可用集合及其元数据。

#### **描述集合**
获取全面的集合信息，包括：
- 字段模式和数据类型
- 索引配置和性能指标
- 行数和存储统计

#### **删除集合**
带确认要求的安全集合移除。

### 数据操作

#### **插入数据**
带验证的批量数据插入：
```json
示例:
[
  {
    "uuid": "doc_001",
    "title": "用户指南",
    "content": "全面的用户说明...",
    "embedding": [0.1, 0.2, 0.3, ...],
    "metadata": {"category": "documentation", "language": "zh"}
  }
]
```

#### **查询数据**
高级数据检索，支持：
- 复杂过滤表达式
- 动态字段选择
- 分页支持
- 性能优化

#### **删除数据**
带安全机制的条件数据移除。

### 搜索与检索

#### **文本嵌入**
使用 Dify 嵌入模型将文本转换为向量：
```yaml
参数:
  text: 输入文本内容
  normalize: L2 标准化选项
```

#### **文本搜索** 
智能语义搜索，支持：
```yaml
参数:
  collection_name: 目标集合
  query_text: 自然语言查询
  limit: 结果数量（1-100）
  output_fields: 逗号分隔的字段列表
  filter: 布尔过滤表达式
  min_similarity: 质量阈值（0.0-1.0）
```

#### **向量搜索**
带高级参数的直接向量相似性搜索。

#### **BM25 搜索**
基于 BM25 排名的传统关键词搜索。

## 📚 文档

### **策略指南**
- **[RAG 策略指南](docs/RAG_STRATEGY_GUIDE.md)**：全面的分块、检索和召回策略
- **[数据库评估](docs/MILVUS_DATABASE_EVALUATION.md)**：性能优化和最佳实践

### **开发资源**
- **[迁移指南](docs/MIGRATION.md)**：从先前版本升级
- **[部署检查表](docs/DEPLOYMENT_CHECKLIST.md)**：生产部署指南
- **[TDD 策略](docs/TDD_STRATEGY.md)**：测试和开发实践

## 🎯 RAG 最佳实践

### **文档分块**
```python
推荐配置:
- 块大小: 500-600 字符
- 重叠: 15-20%（50-100 字符）
- 边界: 段落 + 句子保持
- 最小大小: 100 字符（过滤短块）
```

### **搜索优化**
```python
多路径召回策略:
1. 向量相似性搜索（主要）
2. 关键词匹配（补充）
3. 标题精确匹配（高精度）
4. 同义词查询扩展
5. 结果融合和去重
```

### **性能调优**
```python
索引建议:
- 类型: HNSW（推荐，优于 IVF_FLAT）
- 度量: COSINE（文本最优）
- 参数: M=16, efConstruction=200, ef=128
- 预期: 97%+ 召回率，2-3倍速度提升
```

## 🧪 测试框架

插件包含完整的测试套件：

```bash
# 安装测试依赖
pip install -r test_requirements.txt

# 运行单元测试
pytest tests/unit/ -v

# 运行集成测试
pytest tests/integration/ -v

# 运行带覆盖率的所有测试
pytest --cov=. tests/
```

## 📊 性能指标

### **搜索性能**
- **向量搜索**: < 100ms 平均响应时间
- **文本搜索**: < 200ms 端到端（包括嵌入）
- **BM25 搜索**: < 50ms 关键词匹配
- **混合搜索**: < 300ms 组合操作

### **召回优化**
- **单一向量**: 85-90% 召回率
- **多路径召回**: 95-97% 召回率
- **查询扩展**: +5-10% 覆盖率提升
- **相似度过滤**: 精确度提升至 80-85%

## 🔧 故障排除

### 常见问题

**空搜索结果**
- 确保集合已加载：`client.load_collection(collection_name)`
- 检查数据存在：`client.get_collection_stats(collection_name)`
- 验证 output_fields：对文本数据使用 `"uuid,title,content"`

**模型选择问题**
- 需要 Dify 1.6.0+ 进行系统级模型管理
- 在 Dify 工作空间设置中配置嵌入模型
- 确保在 manifest.yaml 中启用 text_embedding 权限

**性能问题**
- 从 IVF_FLAT 升级索引到 HNSW
- 调整 ef 参数：64（快速）→ 128（平衡）→ 256（精确）
- 启用集合加载以加快查询速度

## 🔒 安全与隐私

### **数据保护**
- 所有处理遵循 Milvus 服务器安全配置
- 文本嵌入由 Dify 安全模型系统处理
- 插件组件内无数据持久化
- 所有操作的审计日志

### **身份验证**
- 通过 Dify 平台的安全凭据管理
- 支持用户/密码和基于令牌的认证
- 连接加密和超时保护

## 📈 路线图

### **版本 0.1.0（计划中）**
- [ ] 多模态搜索（文本 + 图像向量）
- [ ] 高级查询分析和指标
- [ ] 自动扩展索引管理
- [ ] 实时数据流支持

### **版本 0.2.0（未来）**
- [ ] GraphQL 查询接口
- [ ] 基于机器学习的查询优化
- [ ] 跨多个 Milvus 实例的分布式搜索
- [ ] 高级安全功能和审计跟踪

## 📞 支持

### **社区**
- **问题反馈**: [GitHub Issues](https://github.com/VibeAny/pymilvus-dify-plugin/issues)
- **讨论**: [GitHub Discussions](https://github.com/VibeAny/pymilvus-dify-plugin/discussions)
- **文档**: [Wiki 页面](https://github.com/VibeAny/pymilvus-dify-plugin/wiki)

### **企业支持**
对于生产部署和企业功能，请通过官方渠道联系开发团队。

## 📄 许可证与归属

- **许可证**: MIT License
- **维护者**: VibeAny 开发团队
- **版本**: 0.0.1
- **最后更新**: 2024-09-28

### **依赖**
- PyMilvus 2.6.0+: 高性能 Milvus 客户端
- Dify 插件框架: 平台集成层
- 支持库: 完整列表请查看 requirements.txt

---

**⭐ 如果您觉得有用，请为此仓库点星！**

**🤝 欢迎贡献** - 请查看 [CONTRIBUTING.md] 了解指导原则。

 